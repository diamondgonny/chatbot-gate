services:
  mongodb:
    image: mongo:7.0.14
    container_name: chatbot-gate-mongo
    restart: unless-stopped

    ports:
      # Bind to localhost only for security
      - "127.0.0.1:27017:27017"

    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-chatbot_gate}

    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      # Backup volume
      - ./backups/mongodb:/backups

    # Health check for MongoDB
    healthcheck:
      test: |
        mongosh --quiet --eval "db.adminCommand('ping').ok" --username $${MONGO_INITDB_ROOT_USERNAME} --password $${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Resource limits

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=mongodb"

    networks:
      - chatbot-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
      args:
        NODE_ENV: production

    image: chatbot-gate-backend:${VERSION:-latest}
    container_name: chatbot-gate-backend
    restart: unless-stopped

    ports:
      # Bind to localhost only - Cloudflare Tunnel handles external access
      - "127.0.0.1:4000:4000"

    environment:
      NODE_ENV: production
      PORT: 4000
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/${MONGO_INITDB_DATABASE:-chatbot_gate}?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      VALID_CODES: ${VALID_CODES:-sample-code-1,sample-code-2}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      FRONTEND_URLS: ${FRONTEND_URLS}

    depends_on:
      mongodb:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

    # Resource limits

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=backend"

    networks:
      - chatbot-network

    # Security: Read-only root filesystem (except /app/logs)
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    volumes:
      - ./backend/logs:/app/logs

  cloudflared:
    image: cloudflare/cloudflared:2024.11.0
    container_name: chatbot-gate-tunnel
    restart: unless-stopped

    command: tunnel run

    environment:
      TUNNEL_TOKEN: ${TUNNEL_TOKEN}

    depends_on:
      backend:
        condition: service_healthy

    # Health check (tunnel status)
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://backend:4000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

    # Resource limits

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
        labels: "service=cloudflared"

    networks:
      - chatbot-network

networks:
  chatbot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
