services:
  mongodb:
    image: mongo:7.0.14
    container_name: chatbot-gate-mongo
    restart: unless-stopped

    ports:
      # Bind to localhost only for security
      - "127.0.0.1:27017:27017"

    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-chatbot_gate}

    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      # Backup volume
      - ./backups/mongodb:/backups

    # Health check for MongoDB
    healthcheck:
      test: |
        mongosh --quiet --eval "db.adminCommand('ping').ok" --username $${MONGO_INITDB_ROOT_USERNAME} --password $${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Resource limits

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=mongodb"

    networks:
      - chatbot-gate_internal

  # Blue Environment (Port 4000)
  backend-blue:
    image: ghcr.io/${GITHUB_REPO}/chatbot-gate-backend:${VERSION:-latest}
    pull_policy: always
    container_name: chatbot-gate-backend-blue
    restart: unless-stopped

    environment:
      NODE_ENV: production
      PORT: 4000
      DEPLOYMENT_ENV: blue
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/${MONGO_INITDB_DATABASE:-chatbot_gate}?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      VALID_CODES: ${VALID_CODES:-sample-code-1,sample-code-2}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      FRONTEND_URLS: ${FRONTEND_URLS}

    depends_on:
      mongodb:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

    # Resource limits

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=backend-blue"

    networks:
      - chatbot-gate_internal
      - caddy_downstream

    # Security: Read-only root filesystem (except /app/logs)
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    volumes:
      - ./logs/blue:/app/logs

    profiles:
      - blue

  # Green Environment (Port 4001)
  backend-green:
    image: ghcr.io/${GITHUB_REPO}/chatbot-gate-backend:${VERSION:-latest}
    pull_policy: always
    container_name: chatbot-gate-backend-green
    restart: unless-stopped

    environment:
      NODE_ENV: production
      PORT: 4000
      DEPLOYMENT_ENV: green
      MONGO_URI: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongodb:27017/${MONGO_INITDB_DATABASE:-chatbot_gate}?authSource=admin
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      VALID_CODES: ${VALID_CODES:-sample-code-1,sample-code-2}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      FRONTEND_URLS: ${FRONTEND_URLS}

    depends_on:
      mongodb:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

    # Resource limits

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=backend-green"

    networks:
      - chatbot-gate_internal
      - caddy_downstream

    # Security: Read-only root filesystem (except /app/logs)
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    volumes:
      - ./logs/green:/app/logs

    profiles:
      - green

networks:
  chatbot-gate_internal:
    driver: bridge
  caddy_downstream:
    external: true

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
